name: vprofile actions
on: workflow_dispatch

env:
  AWS_REGION: us-east-1
  ECR_REPO_APP: vprofileapp
  ECR_REPO_DB: vprofiledb
  EKS_CLUSTER: kitops-eks
  
jobs:
    BUILD_AND_PUBLISH:
     runs-on: ubuntu-latest
     steps:
       - name: Code checkout
         uses: actions/checkout@v4

       - name: üõ†Ô∏è Set up QEMU (cho multi-platform builds)
         uses: docker/setup-qemu-action@v3

       - name: üèóÔ∏è Set up Docker Buildx (c√¥ng c·ª• build m·∫°nh m·∫Ω)
         uses: docker/setup-buildx-action@v3


       - name: Code checkout
         uses: actions/checkout@v4

       - name: Build & Upload image vproapp to ECR
         uses: appleboy/docker-ecr-action@master
         with:
           access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
           secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
           registry: ${{ secrets.REGISTRY }}
           repo: ${{ env.ECR_REPO_APP }}
           region: ${{ env.AWS_REGION }}
           tags: latest,${{ github.run_number }}
           daemon_off: false
           dockerfile: ./Dockerfile
           context: ./

       - name: Build & Upload image vprodb to ECR
         uses: appleboy/docker-ecr-action@master
         with:
           access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
           secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
           registry: ${{ secrets.REGISTRY_DB }}
           repo: ${{ env.ECR_REPO_DB }}
           region: ${{ env.AWS_REGION }}
           tags: latest,${{ github.run_number }}
           daemon_off: false
           dockerfile: ./container/db/Dockerfile.db
           context: ./
        
      #  - name: üîë Log in to Docker Hub
      #    uses: docker/login-action@v3
      #    with:
      #      username: ${{ secrets.DOCKER_USERNAME }}
      #      password: ${{ secrets.DOCKERHUB_TOKEN }}

      #  - name: Build and Push vprofileapp
      #    uses: docker/build-push-action@v6
      #    with:
      #      context: .              
      #      file: Dockerfile        
      #      push: true
      #      tags: ${{ secrets.DOCKER_USERNAME }}/vprofileapp:latest

      #  - name: Build and Push vprofiledb
      #    uses: docker/build-push-action@v6
      #    with:
      #      context: ./container/db/             
      #      file: ./container/db/Dockerfile.db        
      #      push: true
      #      tags: ${{ secrets.DOCKER_USERNAME }}/vprofiledb:latest
      #      no-cache: true